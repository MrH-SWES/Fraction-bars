<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Fraction Bars Ultimate</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;800&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg-color: #f3f4f6;
      --text-color: #1f2937;
      --panel-bg: #ffffff;
      --border-color: #e5e7eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Lexend', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* --- TOP TOOLBAR --- */
    #topBar {
      background: #1f2937;
      color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 60;
      flex-wrap: wrap;
      gap: 10px;
    }

    .tool-group { display: flex; align-items: center; gap: 15px; }
    .toggle-label { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; cursor: pointer; user-select: none; }
    
    /* Custom Checkbox Style */
    input[type="checkbox"] { transform: scale(1.2); cursor: pointer; accent-color: #3b82f6; }

    /* Total Display */
    #totalDisplay {
      background: #374151;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
      font-family: monospace;
      font-size: 1.1rem;
      min-width: 80px;
      text-align: center;
      border: 1px solid #4b5563;
    }
    .hidden { visibility: hidden; opacity: 0; }

    /* --- WORK AREA --- */
    #workPane {
      flex: 1;
      overflow-y: auto;
      padding: 30px 20px 100px 20px; /* Bottom padding for fixed footer */
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    #barsWrapper {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* --- RULER --- */
    #rulerLine {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: #ef4444;
      border-left: 1px dashed rgba(255,255,255,0.5);
      pointer-events: none;
      z-index: 50;
      display: none; /* Toggled via JS */
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }
    #rulerLabel {
      position: absolute;
      top: -25px;
      left: -20px;
      background: #ef4444;
      color: white;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
    }

    /* --- FRACTION BARS --- */
    .fraction-row {
      display: flex;
      align-items: center;
      gap: 10px;
      /* Animation for adding new bars */
      animation: slideIn 0.3s ease-out;
      background: transparent;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .drag-handle {
      cursor: grab;
      color: #9ca3af;
      font-size: 1.5rem;
      line-height: 1;
      padding: 0 5px;
      user-select: none;
    }
    .drag-handle:active { cursor: grabbing; color: #4b5563; }

    .row-label {
      width: 50px;
      text-align: right;
      font-size: 0.9rem;
      font-weight: 600;
      color: #6b7280;
    }

    .fraction-bar {
      flex: 1;
      height: 55px;
      display: flex;
      border: 2px solid var(--bar-color); /* Dynamic Color */
      border-radius: 8px;
      overflow: hidden;
      background: #ffffff;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
    }

    .segment {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      /* Default State: Outline style */
      color: var(--bar-color); 
      border-right: 1px solid var(--bar-color);
      cursor: pointer;
      user-select: none;
      transition: all 0.1s ease;
    }
    .segment:last-child { border-right: none; }

    .segment:hover {
      background-color: rgba(0,0,0,0.03);
    }

    /* ACTIVE STATE: Filled */
    .segment.selected {
      background-color: var(--bar-color);
      color: white;
    }
    
    /* While dragging styling */
    .fraction-row.dragging {
      opacity: 0.5;
      border: 2px dashed #9ca3af;
      border-radius: 8px;
    }

    /* --- FOOTER CONTROLS --- */
    #controls {
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
      z-index: 100;
    }

    .control-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      font-family: 'Lexend', sans-serif;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, background 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    button:active { transform: translateY(1px); }

    .preset-btn {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .preset-btn:hover { background: #e5e7eb; }

    /* Custom Input Styling */
    .custom-group {
      display: flex;
      gap: 5px;
      background: #f3f4f6;
      padding: 4px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    #customInput {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-family: 'Lexend', sans-serif;
    }
    .add-btn {
      background: #3b82f6;
      color: white;
    }
    .add-btn:hover { background: #2563eb; }

    .reset-btn {
      background: #ef4444;
      color: white;
    }
    .reset-btn:hover { background: #dc2626; }

  </style>
</head>
<body>

  <!-- Top Settings Bar -->
  <div id="topBar">
    <div class="tool-group">
      <label class="toggle-label">
        <input type="checkbox" id="rulerToggle"> 
        <span>Ruler Tool</span>
      </label>
      <label class="toggle-label">
        <input type="checkbox" id="totalToggle" checked> 
        <span>Show Decimal</span>
      </label>
    </div>
    <div id="totalDisplay">Total: 0</div>
  </div>

  <!-- Work Area -->
  <div id="workPane">
    <div id="rulerLine"><div id="rulerLabel"></div></div>
    
    <div id="barsWrapper">
      <!-- Bars injected here via JS -->
    </div>
  </div>

  <!-- Bottom Controls -->
  <div id="controls">
    <!-- Standard Fractions -->
    <div class="control-row">
      <button class="preset-btn" onclick="addBar(2)">1/2</button>
      <button class="preset-btn" onclick="addBar(3)">1/3</button>
      <button class="preset-btn" onclick="addBar(4)">1/4</button>
      <button class="preset-btn" onclick="addBar(5)">1/5</button>
      <button class="preset-btn" onclick="addBar(6)">1/6</button>
      <button class="preset-btn" onclick="addBar(8)">1/8</button>
      <button class="preset-btn" onclick="addBar(10)">1/10</button>
      <button class="preset-btn" onclick="addBar(12)">1/12</button>
    </div>
    
    <!-- Advanced Controls -->
    <div class="control-row">
      <div class="custom-group">
        <input type="number" id="customInput" placeholder="#" min="1" max="50">
        <button class="add-btn" id="addCustomBtn">Add</button>
      </div>
      <button class="reset-btn" onclick="resetApp()">Clear All</button>
    </div>
  </div>

  <script>
    // --- STATE ---
    // We store objects: { id: timestamp, denom: number, color: string }
    let bars = []; 
    
    const wrapper = document.getElementById('barsWrapper');
    const rulerLine = document.getElementById('rulerLine');
    const rulerLabel = document.getElementById('rulerLabel');
    const totalDisplay = document.getElementById('totalDisplay');
    
    // --- COLOR GENERATOR ---
    // Generates a consistent HSL color based on the number
    function getColor(n) {
      // Special hardcoded colors for standard fractions to look nice
      const map = {
        1: '#ef4444', 2: '#f97316', 3: '#f59e0b', 4: '#eab308',
        5: '#84cc16', 6: '#22c55e', 8: '#14b8a6', 10: '#0ea5e9', 12: '#6366f1'
      };
      if(map[n]) return map[n];

      // Auto-generate for custom numbers (using golden angle approx to separate colors)
      const hue = (n * 137.508) % 360; 
      return `hsl(${hue}, 75%, 45%)`;
    }

    // --- CORE LOGIC ---

    function init() {
      // Add 1 whole bar by default
      addBar(1);
    }

    function addBar(denom) {
      const id = Date.now() + Math.random(); // Unique ID
      const color = getColor(denom);
      
      const barObj = { id, denom, color };
      bars.push(barObj);
      
      renderBar(barObj);
    }

    // Renders a single bar and appends it (Used for initial add)
    function renderBar(barData) {
      const row = document.createElement('div');
      row.className = 'fraction-row';
      row.setAttribute('draggable', 'true');
      row.dataset.id = barData.id;
      row.style.setProperty('--bar-color', barData.color);

      // Drag Handle
      const handle = document.createElement('div');
      handle.className = 'drag-handle';
      handle.innerHTML = '&#8942;&#8942;'; // Vertical dots
      row.appendChild(handle);

      // Label
      const label = document.createElement('div');
      label.className = 'row-label';
      label.textContent = `1/${barData.denom}`;
      row.appendChild(label);

      // Bar Container
      const bar = document.createElement('div');
      bar.className = 'fraction-bar';

      // Segments
      for(let i=0; i<barData.denom; i++) {
        const seg = document.createElement('div');
        seg.className = 'segment';
        seg.textContent = `1/${barData.denom}`;
        seg.dataset.value = 1 / barData.denom;
        
        // Click Event
        seg.addEventListener('click', () => {
          seg.classList.toggle('selected');
          calculateTotal();
        });
        
        bar.appendChild(seg);
      }

      // Add delete button? (Optional, but let's keep it simple for now: Reset clears all)
      // Or double click handle to remove? Let's double click label to remove.
      label.title = "Double click to remove row";
      label.style.cursor = "pointer";
      label.addEventListener('dblclick', () => removeBar(barData.id));

      row.appendChild(bar);
      
      // Drag Events
      addDragEvents(row);

      wrapper.appendChild(row);
    }

    function removeBar(id) {
      bars = bars.filter(b => b.id !== id);
      const el = document.querySelector(`.fraction-row[data-id='${id}']`);
      if(el) el.remove();
      calculateTotal();
    }

    function resetApp() {
      bars = [];
      wrapper.innerHTML = '';
      calculateTotal();
      addBar(1); // Always nice to have the 1 bar
    }

    function calculateTotal() {
      const selected = document.querySelectorAll('.segment.selected');
      let sum = 0;
      selected.forEach(s => sum += parseFloat(s.dataset.value));
      
      // Clean float math
      sum = Math.round(sum * 10000) / 10000;
      totalDisplay.textContent = `Total: ${sum}`;
    }

    // --- CUSTOM INPUT ---
    document.getElementById('addCustomBtn').addEventListener('click', () => {
      const input = document.getElementById('customInput');
      const val = parseInt(input.value);
      if(val && val > 0 && val <= 100) {
        addBar(val);
        input.value = '';
      } else {
        alert("Please enter a number between 1 and 100");
      }
    });

    // --- DRAG AND DROP LOGIC ---
    let dragSrcEl = null;

    function addDragEvents(row) {
      row.addEventListener('dragstart', function(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.classList.add('dragging');
      });

      row.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        // Re-order the data array based on DOM order
        recalcDataOrder();
      });

      row.addEventListener('dragover', function(e) {
        e.preventDefault(); // Necessary for drop to work
        e.dataTransfer.dropEffect = 'move';
        return false;
      });

      row.addEventListener('dragenter', function(e) {
        // Visual cue logic could go here
      });

      row.addEventListener('drop', function(e) {
        e.stopPropagation();
        if (dragSrcEl !== this) {
          // Swap DOM elements
          // Note: This is a simple swap. For full sorting, insertBefore is usually better.
          // Let's use insertBefore logic for smoother sorting
          const allRows = [...wrapper.querySelectorAll('.fraction-row')];
          const srcIndex = allRows.indexOf(dragSrcEl);
          const targetIndex = allRows.indexOf(this);

          if(srcIndex < targetIndex) {
            this.after(dragSrcEl);
          } else {
            this.before(dragSrcEl);
          }
        }
        return false;
      });
    }

    function recalcDataOrder() {
      // Sync internal array with DOM (if we needed to save state)
      // Currently, the DOM is the source of truth for visual order.
    }

    // --- RULER TOOL ---
    const workPane = document.getElementById('workPane');
    let rulerEnabled = false;

    document.getElementById('rulerToggle').addEventListener('change', (e) => {
      rulerEnabled = e.target.checked;
      rulerLine.style.display = rulerEnabled ? 'block' : 'none';
      if(!rulerEnabled) rulerLabel.style.display = 'none';
    });

    workPane.addEventListener('mousemove', (e) => {
      if (!rulerEnabled) return;

      const rect = workPane.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const wrapperRect = wrapper.getBoundingClientRect();
      const relativeWrapperX = wrapperRect.left - rect.left;

      // Ensure ruler stays within the bars area roughly
      if (x >= relativeWrapperX && x <= (relativeWrapperX + wrapperRect.width)) {
        rulerLine.style.display = 'block';
        rulerLine.style.left = x + 'px';
        
        // Optional: Show approximate value at this position relative to 1 whole
        // Assuming the bars take up 100% of wrapper
        const pct = (e.clientX - wrapperRect.left) / wrapperRect.width;
        if(pct >= 0 && pct <= 1.01) {
            rulerLabel.textContent = pct.toFixed(2);
        }
      } else {
        rulerLine.style.display = 'none';
      }
    });

    workPane.addEventListener('mouseleave', () => {
      if(rulerEnabled) rulerLine.style.display = 'none';
    });

    // --- TOTAL TOGGLE ---
    document.getElementById('totalToggle').addEventListener('change', (e) => {
      if(e.target.checked) {
        totalDisplay.classList.remove('hidden');
      } else {
        totalDisplay.classList.add('hidden');
      }
    });

    // Start
    init();

  </script>
</body>
</html>
